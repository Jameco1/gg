<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Shape -> MQTT (Diagnostics, WSS:8884)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

  <style>
    :root { --ok:#16a34a; --warn:#eab308; --err:#dc2626; --muted:#6b7280; --bg:#0b1020; --panel:#11172a; --panel2:#0f1526; --text:#e5e7eb; }
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;background:radial-gradient(1000px 600px at 10% -20%,#1b2550,var(--bg));color:var(--text);display:flex;flex-direction:column;align-items:center}
    header,footer{max-width:1100px;width:100%;padding:16px}
    h1{margin:0 0 6px}
    .grid{max-width:1100px;width:100%;display:grid;gap:12px;grid-template-columns:360px 1fr;padding:8px}
    @media(max-width:960px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border-radius:16px;border:1px solid rgba(255,255,255,.06);padding:12px}
    .row{display:flex;gap:8px;align-items:center;margin:6px 0}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--muted)}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.err{background:var(--err)}
    button{border:1px solid rgba(255,255,255,.12);background:#111827;color:#fff;padding:9px 14px;border-radius:10px;cursor:pointer;margin-right:8px}
    #webcam-container canvas{max-width:640px;width:100%;border-radius:12px;border:2px solid rgba(255,255,255,.06);transition:box-shadow .2s}
    .labels{display:grid;gap:6px;margin-top:8px}
    .bar{background:rgba(255,255,255,.06);border-radius:8px;overflow:hidden;position:relative}
    .bar>span{display:block;height:22px;line-height:22px;padding:0 8px}
    .bar::after{content:"";position:absolute;inset:0;width:var(--w,0%);background:linear-gradient(90deg,#2563eb,#4f46e5);opacity:.35}
    .log{height:200px;background:#0b1224;border-radius:12px;padding:8px;overflow:auto;font:12px ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
<header>
  <h1>Teachable Machine (Shapes) → MQTT</h1>
  <div>ตรวจจับ: วงกลม / สามเหลี่ยม / สี่เหลี่ยม แล้วส่งชื่อคลาสไปที่ MQTT topic <b>Opzaa1</b> (WSS:8884)</div>
</header>

<div class="grid">
  <section class="card">
    <h3>สถานะ</h3>
    <div class="row"><span id="dot-mqtt" class="dot"></span> MQTT: <span id="mqtt-state">-</span></div>
    <div class="row"><span id="dot-model" class="dot"></span> Model: <span id="model-state">-</span></div>
    <div class="row"><span id="dot-cam" class="dot"></span> Camera: <span id="cam-state">-</span></div>
    <div class="row"><span id="dot-sub" class="dot"></span> Subscribe: <span id="sub-state">-</span></div>
    <div class="row"><span id="dot-loop" class="dot"></span> Loopback RX: <span id="rx-state">-</span></div>
  </section>

  <section class="card">
    <h3>ควบคุม</h3>
    <div>
      <button onclick="startAll('environment')">Start Back</button>
      <button onclick="startAll('user')">Start Front</button>
      <button onclick="stopAll()">Stop</button>
      <button onclick="safePublish('TEST:'+Date.now())">Test Publish</button>
      <button onclick="$('#log').innerHTML=''">Clear Log</button>
    </div>
    <div style="margin-top:8px;font-size:13px">Broker: <code>wss://broker.hivemq.com:8884/mqtt</code> • Topic: <code>Opzaa1</code></div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <h3>กล้อง & การทำนาย</h3>
    <div id="webcam-container"></div>
    <div class="labels" id="label-container"></div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <h3>Log</h3>
    <div class="log" id="log"></div>
  </section>
</div>

<footer>โมเดลต้องตั้งชื่อคลาสให้ชัด เช่น <code>วงกลม</code>, <code>สามเหลี่ยม</code>, <code>สี่เหลี่ยม</code> (หรือ Circle/Triangle/Square ก็ได้)</footer>

<script>
/* ========= CONFIG ========= */
const TM_URL = "https://teachablemachine.withgoogle.com/models/ahaxFn-GG/"; // <- ใส่ลิงก์โมเดล Shapes ของคุณ
const MQTT_HOST = "broker.hivemq.com";   // WSS only for browser
const MQTT_PORT = 8884;                  // WSS
const MQTT_PATH = "/mqtt";
const MQTT_TOPIC = "Opzaa1";
const CONF_THRESHOLD = 0.80;
const PUBLISH_DEBOUNCE_MS = 2500;

/* ========= UI helpers ========= */
const $ = s => document.querySelector(s);
const dot = (el, state) => { el.classList.remove('ok','warn','err'); if(state) el.classList.add(state); };
const log = (...args) => { const el=$('#log'); const d=document.createElement('div'); d.textContent=args.join(' '); el.appendChild(d); el.scrollTop=el.scrollHeight; console.log(...args); };

/* ========= MQTT via Paho (WSS) ========= */
let mqttClient=null, clientId=null;
function connectMQTT(){
  return new Promise((resolve,reject)=>{
    clientId="web_"+Math.floor(Math.random()*1e6);
    mqttClient=new Paho.MQTT.Client(MQTT_HOST, Number(MQTT_PORT), MQTT_PATH, clientId);

    mqttClient.onConnectionLost = (resp) => { dot($('#dot-mqtt'),'err'); $('#mqtt-state').textContent='lost'; log('MQTT lost', resp?.errorMessage||''); };
    mqttClient.onMessageArrived = (msg) => { dot($('#dot-loop'),'ok'); $('#rx-state').textContent = `${msg.destinationName}: ${msg.payloadString}`; log('RX:', msg.destinationName, msg.payloadString); };

    const will = new Paho.MQTT.Message(JSON.stringify({clientId,status:'offline'}));
    will.destinationName = MQTT_TOPIC + "/status"; will.retained = true;

    mqttClient.connect({
      useSSL:true, timeout:20, keepAliveInterval:60, cleanSession:true, willMessage:will,
      onSuccess:()=>{ dot($('#dot-mqtt'),'ok'); $('#mqtt-state').textContent='connected'; mqttClient.subscribe(MQTT_TOPIC+"/#"); dot($('#dot-sub'),'ok'); $('#sub-state').textContent='subscribed'; resolve(); },
      onFailure:(e)=>{ dot($('#dot-mqtt'),'err'); $('#mqtt-state').textContent='failed'; reject(e); }
    });
  });
}
function safePublish(payload){
  if(!mqttClient || !mqttClient.isConnected()){ log('Publish skipped (not connected)'); return false; }
  try{ const m=new Paho.MQTT.Message(payload); m.destinationName=MQTT_TOPIC; mqttClient.send(m); log('TX:', MQTT_TOPIC, payload); return true; } catch(e){ log('Publish error:', e); return false; }
}

/* ========= Teachable Machine ========= */
let model, webcam, labelContainer, maxPredictions, lastSentAt=0, running=false;
async function loadModel(){
  dot($('#dot-model'),'warn'); $('#model-state').textContent='loading...';
  model = await tmImage.load(TM_URL+'model.json', TM_URL+'metadata.json');
  maxPredictions = model.getTotalClasses();
  $('#model-state').textContent='ready ('+maxPredictions+')'; dot($('#dot-model'),'ok');
  buildLabels();
}
function buildLabels(){
  labelContainer = $('#label-container'); labelContainer.innerHTML='';
  for(let i=0;i<maxPredictions;i++){ const r=document.createElement('div'); r.className='bar'; r.appendChild(document.createElement('span')); labelContainer.appendChild(r); }
}
async function startCamera(facingMode){
  dot($('#dot-cam'),'warn'); $('#cam-state').textContent='requesting...';
  const size = 320;
  webcam = new tmImage.Webcam(size,size,false);
  await webcam.setup({ facingMode }); await webcam.play();
  $('#webcam-container').innerHTML=''; $('#webcam-container').appendChild(webcam.canvas);
  $('#cam-state').textContent='streaming'; dot($('#dot-cam'),'ok');
}
function flash(shape){
  const el = $('#webcam-container canvas');
  const c = (shape==='วงกลม'||shape==='Circle')?'red':(shape==='สามเหลี่ยม'||shape==='Triangle')?'yellow':'dodgerblue';
  el.style.boxShadow = `0 0 20px ${c}`; setTimeout(()=> el.style.boxShadow='', 800);
}
async function predict(){
  const preds = await model.predict(webcam.canvas);
  preds.forEach((p,i)=>{ const row=labelContainer.children[i]; row.style.setProperty('--w', Math.round(p.probability*100)+'%'); row.firstChild.textContent = `${p.className}: ${p.probability.toFixed(2)}`; });
  let best = preds.reduce((a,b)=> b.probability>a.probability?b:a);
  const now = Date.now();
  if(best.probability>=CONF_THRESHOLD && now-lastSentAt>=PUBLISH_DEBOUNCE_MS){
    lastSentAt=now; const ok=safePublish(best.className); if(ok) flash(best.className); dot($('#dot-loop'), ok?'warn':'err');
  }
}
async function loop(){ if(!running) return; webcam.update(); await predict(); requestAnimationFrame(loop); }

/* ========= Orchestration ========= */
async function startAll(face){ running=false; await connectMQTT().catch(()=>{}); await loadModel(); await startCamera(face); running=true; loop(); }
function stopAll(){ running=false; try{webcam.stop()}catch{}; $('#webcam-container').innerHTML=''; dot($('#dot-cam'), null); }

/* Auto start back cam (optional) */
// startAll('environment');
</script>
</body>
</html>

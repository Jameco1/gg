<!DOCTYPE html>
<html>
<head>
  <title>Teachable Machine + MQTT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ‡πÇ‡∏´‡∏•‡∏î TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <!-- ‡πÇ‡∏´‡∏•‡∏î Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <!-- ‡πÇ‡∏´‡∏•‡∏î MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h1>Teachable Machine + MQTT</h1>
  <button type="button" onclick="init()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
  <div id="webcam-container"></div>
  <div id="label-container"></div>

  <script type="text/javascript">
    // ‚úÖ Link model ‡∏à‡∏≤‡∏Å Teachable Machine (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á)
    const URL = "https://teachablemachine.withgoogle.com/models/ENSCy5pbi/";

    let model, webcam, labelContainer, maxPredictions;

    // ‚úÖ MQTT Config
    const broker = "wss://broker.hivemq.com:8884"; 
    const topic = "tm/ccssrr11/device1"; // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ topic ‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    const client = mqtt.connect(broker);

    client.on("connect", () => {
      console.log("‚úÖ Connected to HiveMQ Broker");
      client.subscribe(topic, () => {
        console.log("üì° Subscribed to:", topic);
      });
    });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    async function init() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ webcam
      const flip = true; // ‡∏Å‡∏•‡πâ‡∏≠‡∏á mirror
      webcam = new tmImage.Webcam(200, 200, flip);
      await webcam.setup(); 
      await webcam.play();
      window.requestAnimationFrame(loop);

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
      document.getElementById("webcam-container").appendChild(webcam.canvas);
      labelContainer = document.getElementById("label-container");
      for (let i = 0; i < maxPredictions; i++) {
        labelContainer.appendChild(document.createElement("div"));
      }
    }

    async function loop() {
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }

    // ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•
    async function predict() {
      const prediction = await model.predict(webcam.canvas);
      let bestClass = "";
      let bestProb = 0;

      for (let i = 0; i < maxPredictions; i++) {
        const classPrediction =
          prediction[i].className + ": " + (prediction[i].probability * 100).toFixed(2) + "%";
        labelContainer.childNodes[i].innerHTML = classPrediction;

        if (prediction[i].probability > bestProb) {
          bestProb = prediction[i].probability;
          bestClass = prediction[i].className;
        }
      }

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 80% ‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ HiveMQ
      if (bestProb > 0.8) {
        let message = "";
        if (bestClass === "Circle") {
          message = "‡∏ß‡∏á‡∏Å‡∏•‡∏°";
        } else if (bestClass === "Triangle") {
          message = "‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°";
        } else if (bestClass === "Square") {
          message = "‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°";
        }

        if (message !== "") {
          client.publish(topic, message, { qos: 0 }, (err) => {
            if (err) console.error("‚ùå Publish error:", err);
            else console.log("üì§ ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ MQTT:", message);
          });
        }
      }
    }
  </script>
</body>
</html>
